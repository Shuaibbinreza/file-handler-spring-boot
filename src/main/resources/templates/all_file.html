<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>File Upload</title>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>

<body>

    <h2>Upload File</h2>

    <form id="uploadForm" enctype="multipart/form-data">
        <input type="file" name="file" id="fileInput" />
        <button type="submit">Upload</button>
    </form>

    <p id="msg"></p>

    <hr />

    <h2>Uploaded Files</h2>

    <table border="1">
        <thead>
            <tr>
                <th>ID</th>
                <th>Original Name</th>
                <th>Uploaded At</th>
                <th>Action</th>
            </tr>
        </thead>

        <tbody id="fileTableBody">
            <tr th:each="file : ${files}">
                <td th:text="${file.id}"></td>
                <td th:text="${file.originalName}"></td>
                <td th:text="${file.uploadedAt}"></td>
                <td>
                    <a th:href="@{'/api/files/download/' + ${file.id}}">Download</a>
                </td>
            </tr>
        </tbody>
    </table>

<script>
$(document).ready(function () {

    // 1️⃣ Load the table on page load
    loadFiles();

    // 2️⃣ AJAX file upload
    $("#uploadForm").on("submit", function(e) {
        e.preventDefault();

        let fileInput = $("#fileInput")[0];
        if (!fileInput.files.length) {
            alert("Please select a file");
            return;
        }

        let formData = new FormData(this);

        $.ajax({
            url: "/api/files/upload",  // REST endpoint
            type: "POST",
            data: formData,
            contentType: false,
            processData: false,
            success: function(data) {
                $("#msg").text("File uploaded successfully: " + data.originalName);
                $("#fileInput").val(""); // reset file input
                loadFiles(); // reload table
            },
            error: function() {
                $("#msg").text("Upload failed!");
            }
        });
    });

    // 3️⃣ Load files and render table
    function loadFiles() {
        $.ajax({
            url: "/api/files",
            type: "GET",
            success: function(files) {
                let tbody = $("#fileTableBody");
                tbody.empty();

                $.each(files, function(i, file) {
                    tbody.append(`
                        <tr>
                            <td>${file.id}</td>
                            <td>${file.originalName}</td>
                            <td>${file.uploadedAt}</td>
                            <td>
                                <a href="/api/files/download/${file.id}">Download</a>
                                &nbsp;|&nbsp;
                                <button class="deleteBtn" data-id="${file.id}">Delete</button>
                            </td>
                        </tr>
                    `);
                });

                // 4️⃣ Attach delete handlers AFTER table is created
                $(".deleteBtn").off("click").on("click", function() {
                    let fileId = $(this).data("id");
                    if (confirm("Are you sure you want to delete this file?")) {
                        $.ajax({
                            url: "/api/files/" + fileId,
                            type: "DELETE",
                            success: function() {
                                alert("File deleted successfully");
                                loadFiles();
                            },
                            error: function() {
                                alert("Delete failed");
                            }
                        });
                    }
                });
            },
            error: function() {
                console.error("Failed to load files");
            }
        });
    }

});
</script>


</body>

</html>